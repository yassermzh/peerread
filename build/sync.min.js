/*! peerread 2013-11-05 */
function initFrame(){console.log("initFrame called...");var a=document.getElementsByTagName("iframe")[0];frameDoc=a.contentDocument,a.contentWindow.onscroll=syncScroll,frameInited=!0,console.log("initFrame cont...");for(var b=frameDoc.getElementsByTagName("a"),c=0;c<b.length;c++)setClickHandler(b[c])}function init(){console.log("window init called..."),frame=document.getElementsByTagName("iframe")[0],initSync()}function setClickHandler(a){a.addEventListener("click",function(b){b.preventDefault();var c=a.getAttribute("href");console.log(c),makeRequest(c)},!1)}function makeRequest(a){return window.XMLHttpRequest&&(httpRequest=new XMLHttpRequest),httpRequest?(httpRequest.onreadystatechange=publishUrlContent,console.log("getting url="+a),httpRequest.open("POST","/getURL",!0),httpRequest.setRequestHeader("Content-Type","application/json;charset=UTF-8"),httpRequest.send(JSON.stringify({url:a})),reqUrl=a,void 0):(alert("Giving up :( Cannot create an XMLHTTP instance"),!1)}function publishUrlContent(){4===httpRequest.readyState&&(200===httpRequest.status?(frameDoc.location="./page.html",document.getElementById("urlFrame").value=reqUrl,console.log("now reqUrl="+reqUrl)):alert("There was a problem with the request."))}function syncScroll(){console.log("scrollY="+frameDoc.body.scrollTop),syncSocket.send(JSON.stringify({msg:"scroll",scrollY:frameDoc.body.scrollTop}))}function initSync(){syncSocket=new WebSocket(wsServerUrl,"echo-protocol"),syncSocket.onopen=function(){syncSocket.send(JSON.stringify({msg:"helo"}))},syncSocket.onmessage=function(a){console.log(a.data);var b=JSON.parse(a.data);switch(b.msg){case"scroll":frameDoc.body.scrollTop=b.scrollY}}}var frame,frameDoc,wsServerUrl="ws://192.168.137.144:8080/",syncSocket,reqUrl;window.onload=init,document.getElementsByTagName("iframe")[0].onload=initFrame;